{% comment %} Product Detail Section {% endcomment %}

<!-- p_mainvisual -->
<section class="p_mainvisual">
  <div class="p_mainvisual_inner">
    <h1 class="p_mainvisual_title">{{ section.settings.page_title | default: 'Product Details' }}</h1>
    <p class="p_mainvisual_desc">{{ section.settings.page_description | default: 'Discover the perfect water solution for your needs' }}</p>
  </div>
</section>

<!-- Product Breadcrumb -->
<section id="product_breadcrumb">
  <div class="product_breadcrumb_inner">
    <a href="{{ routes.root_url }}" class="product_breadcrumb_link">Home</a>
    <span class="product_breadcrumb_separator">/</span>
    <a href="{{ routes.collections_url }}/all" class="product_breadcrumb_link">Products</a>
    <span class="product_breadcrumb_separator">/</span>
    <span class="product_breadcrumb_current">{{ product.title }}</span>
  </div>
</section>

<!-- Product Detail -->
<section id="product_detail">
  <div class="product_detail_inner">
    <div class="product_detail_gallery">
      <div class="product_detail_image">
        {%- if product.featured_image -%}
          {{ product.featured_image | image_url: width: 800 | image_tag: alt: product.title }}
        {%- else -%}
          <img src="{{ 'images/common/dummy.jpg' | asset_url }}" alt="{{ product.title }}">
        {%- endif -%}
      </div>
    </div>

    <div class="product_detail_info">
      {%- if product.type != blank -%}
        <div class="product_detail_badge">{{ product.type }}</div>
      {%- endif -%}
      
      <h1 class="product_detail_title">{{ product.title }}</h1>
      
      {%- if product.metafields.reviews.rating -%}
        <div class="product_detail_rating">
          <div class="product_rating_stars">
            {%- assign rating = product.metafields.reviews.rating | default: 5 -%}
            {%- for i in (1..5) -%}
              <svg class="product_star {% if i <= rating %}filled{% endif %}" viewBox="0 0 24 24">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
            {%- endfor -%}
          </div>
          <span class="product_rating_text">{{ rating }}.0 ({{ product.metafields.reviews.count | default: 0 }} reviews)</span>
        </div>
      {%- endif -%}
      
      <div class="product_detail_price" id="productPrice">
        {{ product.selected_or_first_available_variant.price | money }}
      </div>
      
      <p class="product_detail_desc">
        {{ product.description }}
      </p>

      {%- if section.settings.show_features and product.metafields.custom.features != blank -%}
        <div class="product_detail_features">
          <h3 class="product_features_title">Key Features</h3>
          <ul class="product_features_list">
            {%- assign features = product.metafields.custom.features | split: ',' -%}
            {%- for feature in features -%}
              <li>{{ feature }}</li>
            {%- endfor -%}
          </ul>
        </div>
      {%- endif -%}

      <form action="/cart/add" method="post" enctype="multipart/form-data" id="productForm">
        {%- unless product.has_only_default_variant -%}
          <div class="product_detail_variants">
            <label for="productVariant">Size:</label>
            <select name="id" id="productVariant" class="product_variant_select">
              {%- for variant in product.variants -%}
                <option 
                  value="{{ variant.id }}"
                  {% if variant == product.selected_or_first_available_variant %}selected{% endif %}
                  {% unless variant.available %}disabled{% endunless %}
                  data-price="{{ variant.price }}"
                >
                  {{ variant.title }} - {{ variant.price | money }}
                  {% unless variant.available %} (Sold Out){% endunless %}
                </option>
              {%- endfor -%}
            </select>
          </div>
        {%- else -%}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
        {%- endunless -%}

        <div class="product_detail_actions">
          <div class="product_quantity">
            <button type="button" class="product_quantity_btn" id="decreaseQty">-</button>
            <input type="number" name="quantity" class="product_quantity_input" value="1" min="1" max="99" id="productQuantity">
            <button type="button" class="product_quantity_btn" id="increaseQty">+</button>
          </div>
          <button type="button" class="btn_primary product_add_btn" id="addToCartBtn">
            Add to Cart
          </button>
        </div>
      </form>

      <div class="product_detail_meta">
        {%- if product.selected_or_first_available_variant.sku != blank -%}
          <div class="product_meta_item">
            <span class="product_meta_label">SKU:</span>
            <span class="product_meta_value">{{ product.selected_or_first_available_variant.sku }}</span>
          </div>
        {%- endif -%}
        {%- if product.type != blank -%}
          <div class="product_meta_item">
            <span class="product_meta_label">Category:</span>
            <span class="product_meta_value">{{ product.type }}</span>
          </div>
        {%- endif -%}
        {%- if product.tags.size > 0 -%}
          <div class="product_meta_item">
            <span class="product_meta_label">Tags:</span>
            <span class="product_meta_value">{{ product.tags | join: ', ' }}</span>
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</section>

<!-- Product Tabs -->
<section id="product_tabs">
  <div class="product_tabs_inner">
    <div class="product_tabs_nav">
      <button class="product_tab_btn active" data-tab="description">Description</button>
      {%- if section.settings.show_nutrition -%}
        <button class="product_tab_btn" data-tab="nutrition">Nutritional Info</button>
      {%- endif -%}
      {%- if section.settings.show_reviews -%}
        <button class="product_tab_btn" data-tab="reviews">Reviews</button>
      {%- endif -%}
    </div>

    <div class="product_tabs_content">
      <div class="product_tab_panel active" id="description">
        <h3 class="product_tab_title">Product Description</h3>
        <div class="product_tab_text">
          {{ product.description }}
        </div>
      </div>

      {%- if section.settings.show_nutrition -%}
        <div class="product_tab_panel" id="nutrition">
          <h3 class="product_tab_title">Nutritional Information</h3>
          {%- if product.metafields.custom.nutrition_table != blank -%}
            {{ product.metafields.custom.nutrition_table }}
          {%- else -%}
            <table class="product_nutrition_table">
              <tr><td>Serving Size</td><td>8 fl oz (240ml)</td></tr>
              <tr><td>Calories</td><td>0</td></tr>
              <tr><td>Total Fat</td><td>0g</td></tr>
              <tr><td>Sodium</td><td>5mg</td></tr>
              <tr><td>Total Carbohydrate</td><td>0g</td></tr>
              <tr><td>Protein</td><td>0g</td></tr>
            </table>
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- if section.settings.show_reviews -%}
        <div class="product_tab_panel" id="reviews">
          <h3 class="product_tab_title">Customer Reviews</h3>
          <div class="product_reviews">
            {%- comment -%} Placeholder for reviews - integrate with review app {%- endcomment -%}
            <p>Customer reviews will appear here.</p>
          </div>
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

<!-- Related Products -->
{%- if section.settings.show_related_products -%}
  <section id="product_related">
    <div class="product_related_inner">
      <h2 class="product_related_title">{{ section.settings.related_products_title | default: 'Related Products' }}</h2>
      <div class="product_grid" id="productsList">
        {%- assign related_products = product.collections.first.products | where_exp: "item", "item.id != product.id" | limit: 4 -%}
        {%- for related_product in related_products -%}
          <a href="{{ related_product.url }}" class="product_card">
            <div class="product_card_image">
              {%- if related_product.featured_image -%}
                {{ related_product.featured_image | image_url: width: 400 | image_tag: alt: related_product.title }}
              {%- else -%}
                <img src="{{ 'images/common/dummy.jpg' | asset_url }}" alt="{{ related_product.title }}">
              {%- endif -%}
            </div>
            <div class="product_card_content">
              <div>
                <p class="product_card_category">{{ related_product.type | upcase }}</p>
                <h3 class="product_card_name">{{ related_product.title }}</h3>
              </div>
              <div class="product_card_footer">
                <span class="product_card_price">{{ related_product.price | money }}</span>
                {%- if related_product.variants.first.title != 'Default Title' -%}
                  <span class="product_card_size">{{ related_product.variants.first.title }}</span>
                {%- endif -%}
              </div>
              <button class="product_card_btn" onclick="event.preventDefault(); event.stopPropagation(); addToCart({{ related_product.variants.first.id }})">
                <svg class="product_card_btn_icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <circle cx="9" cy="21" r="1"/>
                  <circle cx="20" cy="21" r="1"/>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                </svg>
                Add to Cart
              </button>
            </div>
          </a>
        {%- endfor -%}
      </div>
    </div>
  </section>
{%- endif -%}

{% render 'cart-notifications' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Quantity controls
  const qtyInput = document.getElementById('productQuantity');
  const decreaseBtn = document.getElementById('decreaseQty');
  const increaseBtn = document.getElementById('increaseQty');
  
  if (decreaseBtn) {
    decreaseBtn.addEventListener('click', function() {
      let value = parseInt(qtyInput.value);
      if (value > 1) {
        qtyInput.value = value - 1;
      }
    });
  }
  
  if (increaseBtn) {
    increaseBtn.addEventListener('click', function() {
      let value = parseInt(qtyInput.value);
      if (value < 99) {
        qtyInput.value = value + 1;
      }
    });
  }
  
  // Variant selector - update price
  const variantSelect = document.getElementById('productVariant');
  const priceDisplay = document.getElementById('productPrice');
  
  if (variantSelect && priceDisplay) {
    variantSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const price = selectedOption.getAttribute('data-price');
      if (price) {
        // Format price (basic formatting - Shopify will handle this better)
        const formattedPrice = '$' + (parseInt(price) / 100).toFixed(2);
        priceDisplay.textContent = formattedPrice;
      }
    });
  }
  
  // Add to cart button
  const addToCartBtn = document.getElementById('addToCartBtn');
  const productForm = document.getElementById('productForm');
  
  if (addToCartBtn && productForm) {
    addToCartBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(productForm);
      const variantId = formData.get('id');
      const quantity = parseInt(formData.get('quantity'));
      
      // Use cart-handler.js function
      if (typeof addToCart === 'function') {
        await addToCart(variantId, quantity);
      }
    });
  }
  
  // Product tabs
  const tabBtns = document.querySelectorAll('.product_tab_btn');
  const tabPanels = document.querySelectorAll('.product_tab_panel');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Remove active class from all
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanels.forEach(p => p.classList.remove('active'));
      
      // Add active class to current
      this.classList.add('active');
      document.getElementById(tabId).classList.add('active');
    });
  });
});
</script>

{% schema %}
{
  "name": "Product Detail",
  "settings": [
    {
      "type": "text",
      "id": "page_title",
      "label": "Page Title",
      "default": "Product Details"
    },
    {
      "type": "text",
      "id": "page_description",
      "label": "Page Description",
      "default": "Discover the perfect water solution for your needs"
    },
    {
      "type": "checkbox",
      "id": "show_features",
      "label": "Show Features Section",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_nutrition",
      "label": "Show Nutrition Tab",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_reviews",
      "label": "Show Reviews Tab",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_related_products",
      "label": "Show Related Products",
      "default": true
    },
    {
      "type": "text",
      "id": "related_products_title",
      "label": "Related Products Title",
      "default": "Related Products"
    }
  ]
}
{% endschema %}
